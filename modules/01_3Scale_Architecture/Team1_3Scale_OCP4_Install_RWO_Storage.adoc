# OCP Environment

1. Start with the OCP 4.8 workshop deployer on RHPDS.
2. `ssh` to the bastion using the SSH password provided in the email.
3. `sudo` as `root` user:
  
  # sudo -i
  
4. Create `3scale-amp` project.

  # oc new-project 3scale-amp

5. Find the resource limits for this project:

  # oc get limitranges
  NAME                              CREATED AT
  3scale-amp-core-resource-limits   2019-12-17T15:33:34Z

6. Edit the resource limit `3scale-amp-core-resource-limits` to change the resource limits as follows. The limit for memory as changed here to `32 GB` to ensure the `redis-*` pods of 3scale are deployed. This is only the max limit and does not affect the requested resources.

  # oc edit limitranges
  
  [...]
  spec:
    limits:
    - default:
        cpu: 500m
        memory: 1536Mi
      defaultRequest:
        cpu: 50m
        memory: 256Mi
      max:
        cpu: "2"
        memory: 32Gi
      type: Container
    - max:
        cpu: "2"
        memory: 32Gi
      type: Pod

7. Create `system-storage` PVC using this YAML in the `3scale-amp` namespace.

  # vim system-storage-pvc.yaml

  apiVersion: v1
  kind: PersistentVolumeClaim
  metadata:
    # This name uniquely identifies the PVC. Will be used in deployment below.
    name: system-storage
    namespace: 3scale-amp
    labels:
      app: 3scale-api-management
      threescale_component: system
  spec:
    accessModes:
      - ReadWriteOnce
    resources:
      requests:
        storage: 1Gi
    storageClassName: gp2
    volumeMode: Filesystem

   # oc create -f system-storage-pvc.yaml 
   persistentvolumeclaim/system-storage created
    
8. Once this is successful, create the API Manager `amp.yaml` Be sure to update the `wildcardDomain`; example: `apps.cluster-5ffxf.5ffxf.sandbox1868.opentlc.com`

  # vim amp.yaml
  
  apiVersion: apps.3scale.net/v1alpha1
  kind: APIManager
  metadata:
    name: apimanager
  spec:
    system:
      fileStorage:
        persistentVolumeClaim:
          storageClassName: gp2
      redisResources:
        limits:
          memory: 6Gi
    backend:
      redisResources:
        limits:
          memory: 6Gi
    wildcardDomain: "{{ route_subdomain }}" 

9. Create the API Manager specification `amp-s3.yml`. Be sure to update the `wildcardDomain`.

  apiVersion: apps.3scale.net/v1alpha1
  kind: APIManager
  metadata:
    name: "3scale-amp"
    namespace: "3scale-amp"
  spec:
    wildcardDomain: "{{ route_subdomain }}"
    resourceRequirementsEnabled: false

10. After few minutes your API Manager Pods will be up and you should be able to access the `3scale-admin` URL.

  # oc get pods -n 3scale-amp

# Optional:

### SMTP Access
1. Create the `smtp.yml` configmap to configure SMTP access:

  kind: ConfigMap
  apiVersion: v1
  metadata:
    name: smtp
    labels:
      app: 3scale-api-management
      threescale_component: system
      threescale_component_element: smtp
  data:
    address: 'smtp.gmail.com'
    authentication: 'login'
    domain: 'redhat.com'
    openssl.verify.mode: 'false'
    password: '<< your password>>'
    port: '587'
    username: '<< your userid>>'

2. Add the configmap to `3scale-amp` namespace:

  # oc create -f smtp.yml

3. Once SMTP is updated, redeploy the system pods.
